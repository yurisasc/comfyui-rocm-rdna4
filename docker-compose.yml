services:
  comfyui-rocm:
    build:
      context: .
      dockerfile: Dockerfile
    # Uses system python directly to access ROCm 7.1 libraries
    command: python3 main.py --listen 0.0.0.0 --port 8188 --lowvram --force-fp16
    ports:
      - "8188:8188"
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    volumes:
      - ./comfyui_data:/workspace/ComfyUI/user
      - ./storage/ComfyUI/models:/workspace/ComfyUI/models
      - ./storage/ComfyUI/output:/workspace/ComfyUI/output
    environment:
      - PYTHONUNBUFFERED=1
      - HSA_OVERRIDE_GFX_VERSION=12.0.1
      - PYTORCH_ROCM_ARCH=gfx1201
      - ROCM_PATH=/opt/rocm
      - HIP_VISIBLE_DEVICES=0
    # Portable Group IDs handled by .env
    group_add:
      - "${VIDEO_GID:-44}"
      - "${RENDER_GID:-109}"
    restart: unless-stopped
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp:unconfined
    ipc: host
    shm_size: 8G

